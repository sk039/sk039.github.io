<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://kscr-rust.github.io name=base><title>
            
                ebpf 学习笔记
            
        </title><meta content="ebpf 学习笔记" property=og:title><link href=https://kscr-rust.github.io/fonts.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=/syntax-theme-dark.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=/syntax-theme-light.css rel=stylesheet><script async data-goatcounter=https://kscr.goatcounter.com/count src=https://kscr-rust.github.io/js/count.js></script><noscript><img src="https://kscr.goatcounter.com//count?p=/ebpf-notes/&t=ebpf 学习笔记"></noscript><script defer src=https://kscr-rust.github.io/js/toc.js></script><script src=https://kscr-rust.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="
    kscr
" href=https://kscr-rust.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://kscr-rust.github.io/theme/light.css rel=stylesheet><link href=https://kscr-rust.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://kscr-rust.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://kscr-rust.github.io/main.css media=screen rel=stylesheet><script src="https://kscr-rust.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://kscr-rust.github.io>kscr</a><div class=socials><a class=social href=https://github.com/kscr-rust/ rel=me> <img alt=github src=https://kscr-rust.github.io/icons/social/github.svg> </a></div></div><div class=right-nav><a href=https://kscr-rust.github.io style=margin-right:.5em>Home</a><a href=https://kscr-rust.github.io/categories style=margin-right:.5em>Categories</a><a href=https://kscr-rust.github.io/tags style=margin-right:.5em>Tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://kscr-rust.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://kscr-rust.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://kscr-rust.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>ebpf 学习笔记</div><div class=meta>Posted on <time>2022-09-05</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://kscr-rust.github.io/tags/ebpf/>ebpf</a> </span></div></div><section class=body><h2 id=jie-shao>介绍</h2><p><img alt=ebpf架构 src=https://kscr-rust.github.io/ebpf-notes/62831cc15717714b077372c9bcce12e71dfa78.png><p>深入浅出eBPF｜你要了解的七个核心问题：<p>https://www.51cto.com/article/711018.html<p>eBPF 系列一：Hello eBPF<p>https://vvl.me/2021/01/eBPF-1-Hello-eBPF/<p>BPF之路一bpf系统调用<p>https://www.anquanke.com/post/id/263803<h2 id=ebpf-cheng-xu-zhong-xiang-yong-hu-tai-cheng-xu-chuan-di-xin-xi>eBPF 程序中向用户态程序传递信息</h2><ol><li><p>bpf_trace_printk()</p> <p><code>bpf_trace_printk</code> 是一个 BPF 的辅助函数, 其作用是打印输出，由于运行在内核中，所以打印输出并不是标准输出，而是内核调试文件 <code>/sys/kernel/debug/tracing/trace_pipe</code></p> <p>&lt;eBPF-2-实战之编程接口、bcc与bpftrace> lesson1: hello word</p> <p>https://blog.csdn.net/weixin_43988498/article/details/125113777</p><li><p>map</p> <p><strong>BPF 进阶笔记（二）：BPF Map 类型详解：使用场景、程序示例</strong></p> <p>https://arthurchiao.art/blog/bpf-advanced-notes-2-zh/</p> <p>eBPF 系列三：eBPF map</p> <p>https://vvl.me/2021/02/eBPF-3-eBPF-map/</p> <p><strong>BPF ring buffer</strong></p> <p>https://nakryiko.com/posts/bpf-ringbuf/#bpf-ringbuf-vs-bpf-perfbuf</p> <p>边缘网络 eBPF 超能力：eBPF map 原理与性能解析</p> <p>https://segmentfault.com/a/1190000041224609</p> <p>map 性能建议：</p> <ul><li>一般来说 eBPF 程序作为数据面更多是查询，常用的 map 的查询性能：array > percpu array > hash > percpu hash > lru hash > lpm。map 查询对 eBPF 性能有不少的影响，比如：lpm 类型 map 的查询在我们测试发现最大影响 20% 整体性能、lru hash 类型 map 查询影响 10%。 特别注意，array 的查询性能比 percpu array 更好，hash 的查询性能也比 percpu hash 更好，这是由于 array 和 hash 的 lookup helper 层面在内核有更多的优化。对于数据面读多写少情况下，使用 array 比 percpu array 更优（hash、percpu hash 同理），而对于需要数据面写数据的情况使用 percpu 更优，比如统计计数。<li>尽可能在一个 map 中查询到更多的数据，减少 map 查询次数。<li>尽可能使用 array map，在控制面实现更复杂的逻辑，如分配一个 index，将一些 hash map 查询转换为 array map 查询。<li>eBPF map 也可以指定 numa 创建，另外不同类型的 map 也会有一些额外的 flags 可以用来调整特性，比如：lru hash map 有 no_common_lru 选项来优化写入性能。</ul> <p>揭秘 BPF map 前生今世</p> <p>https://www.ebpf.top/post/map_internal/</p> <p><img alt="map 加载流程" src=https://kscr-rust.github.io/ebpf-notes/map_load_process.png></p></ol></section></article></main></div></div><div class=right-content><div class=toc><div class=heading>Table of Contents</div><ul class=toc-list><li class=parent><a href=https://kscr-rust.github.io/ebpf-notes/#jie-shao>介绍</a><li class=parent><a href=https://kscr-rust.github.io/ebpf-notes/#ebpf-cheng-xu-zhong-xiang-yong-hu-tai-cheng-xu-chuan-di-xin-xi>eBPF 程序中向用户态程序传递信息</a></ul></div></div>